services:
  k6-auth:
    image: grafana/k6:latest
    entrypoint: ["/usr/bin/k6"]
    restart: on-failure
    depends_on:
      api-gateway:
        condition: service_healthy
      prometheus:
        condition: service_started
      influxdb:
        condition: service_started
    networks:
      - internal-net
    volumes:
      - ./perf/k6/auth_scenarios.js:/test.js:ro
    environment:
      K6_PROMETHEUS_RW_SERVER_URL: http://prometheus:9090/api/v1/write
      K6_INSECURE_SKIP_TLS_VERIFY: "true"
      BASE_URL: https://api-gateway:8443
      DURATION: ${DURATION:-2m}
      MODE: ${MODE:-load}
      STRESS_STYLE: progressive
      STRESS_STEP_DURATION_LOGIN: 15s
      STRESS_STEP_DURATION_API: 15s
      STRESS_TARGETS_LOGIN: 5,10,15,20,25,30,35,40,45,50
      STRESS_TARGETS_API: 25,35,45,55,65,75,85,95
      LOGIN_RPS: ${LOGIN_RPS:-5}
      API_RPS: ${API_RPS:-50}
      SEARCH_PATH: /search/
      SERVICE_NAME: auth-service
      JWT_SECRET: change-me-in-prod
      JWT_ISSUER: tasknotes-auth
      JWT_AUDIENCE: tasknotes
      TEST_EMAIL: ${TEST_EMAIL:-perftest@example.com}
      TEST_PASSWORD: ${TEST_PASSWORD:-Passw0rd!}
      USE_LOGIN_TOKEN_FOR_API: ${USE_LOGIN_TOKEN_FOR_API:-true}
    command: [
      "run", 
      "/test.js", 
      "--tag", "testid=e2e-auth",
      "-o", "experimental-prometheus-rw",
      "-o", "influxdb=http://tasknotes:changeme@influxdb:8086/k6"
    ]