services:
  k6:
    image: grafana/k6:latest
    restart: on-failure
    depends_on:
      - prometheus
    # Monta el script genérico por servicio dentro del contenedor
    volumes:
      - ./perf/k6/service_scenario.js:/test.js:ro
    environment:
      # Output Prometheus Remote Write (usa el Prometheus del mismo compose)
      K6_PROMETHEUS_RW_SERVER_URL: http://prometheus:9090/api/v1/write
      K6_PROMETHEUS_RW_TREND_AS_GAUGE: "true"
      # Variables para service_scenario.js (ajusta según el servicio)
      BASE_URL: https://localhost:8443
      DURATION: 2m
      API_RPS: "50"
      SCENARIO: ${SCENARIO:-load}
      METHOD: POST
      PATH: /search/
      CONTENT_TYPE: application/json
      BODY: "{\"query\":\"meeting\",\"user_id\":1,\"limit\":20,\"skip\":0}"
      SERVICE_NAME: search-service
      # JWT HS256 para el gateway en e2e/dev
      JWT_SECRET: change-me-in-prod
      JWT_ISSUER: tasknotes-auth
      JWT_AUDIENCE: tasknotes
      USER_ID: "1"
    command: ["run", "/test.js", "-o", "experimental-prometheus-rw"]