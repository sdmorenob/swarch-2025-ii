version: "3.9"

services:
  # =====================
  # Infra compartida
  # =====================
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - internal-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "no"]
    networks:
      - internal-net
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 30s
      timeout: 5s
      retries: 5

  # =====================
  # Postgres por servicio
  # =====================
  postgres-auth:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tasknotes_auth_service
    volumes:
      - pgdata_auth:/var/lib/postgresql/data
      - ./init-scripts/uuid-ossp.sql:/docker-entrypoint-initdb.d/uuid-ossp.sql:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasknotes_auth_service"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-tasks:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tasknotes_tasks_service
    volumes:
      - pgdata_tasks:/var/lib/postgresql/data
      - ./init-scripts/uuid-ossp.sql:/docker-entrypoint-initdb.d/uuid-ossp.sql:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasknotes_tasks_service"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-tags:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tasknotes_tags_service
    volumes:
      - pgdata_tags:/var/lib/postgresql/data
      - ./init-scripts/uuid-ossp.sql:/docker-entrypoint-initdb.d/uuid-ossp.sql:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasknotes_tags_service"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-categories:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tasknotes_categories_dotnet
    volumes:
      - pgdata_categories:/var/lib/postgresql/data
      - ./init-scripts/uuid-ossp.sql:/docker-entrypoint-initdb.d/uuid-ossp.sql:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasknotes_categories_dotnet"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres-user-profile:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tasknotes_user_profile_service
    volumes:
      - pgdata_user_profile:/var/lib/postgresql/data
      - ./init-scripts/uuid-ossp.sql:/docker-entrypoint-initdb.d/uuid-ossp.sql:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d tasknotes_user_profile_service"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =====================
  # Mongo por servicio
  # =====================
  mongo-notes:
    image: mongo:6
    environment:
      MONGO_INITDB_DATABASE: tasknotes
    volumes:
      - mongodata_notes:/data/db
      - ./mongo-init/init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - internal-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5

  mongo-logs:
    image: mongo:6
    environment:
      MONGO_INITDB_DATABASE: tasknotes_logs_service
    volumes:
      - mongodata_logs:/data/db
    networks:
      - internal-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =====================
  # Microservicios
  # =====================
  auth-service:
    build:
      context: ./auth-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-auth:5432/tasknotes_auth_service
    depends_on:
      postgres-auth:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8002/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  auth-service-2:
    build:
      context: ./auth-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-auth:5432/tasknotes_auth_service
    depends_on:
      postgres-auth:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8002/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  tasks-service:
    build:
      context: ./tasks-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-tasks:5432/tasknotes_tasks_service
      RABBITMQ_URL: amqp://rabbitmq:5672
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CERT_PATH: /grpc-certs/tasks.crt
      GRPC_TLS_KEY_PATH: /grpc-certs/tasks.key
      GRPC_TLS_CLIENT_CA_PATH: /grpc-certs/ca.crt
    depends_on:
      postgres-tasks:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8003/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  tasks-service-2:
    build:
      context: ./tasks-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-tasks:5432/tasknotes_tasks_service
      RABBITMQ_URL: amqp://rabbitmq:5672
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CERT_PATH: /grpc-certs/tasks.crt
      GRPC_TLS_KEY_PATH: /grpc-certs/tasks.key
      GRPC_TLS_CLIENT_CA_PATH: /grpc-certs/ca.crt
    depends_on:
      postgres-tasks:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8003/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  notes-service:
    build:
      context: ./notes-service
    environment:
      MONGODB_URL: mongodb://mongo-notes:27017
      MONGODB_DB: tasknotes
      RABBITMQ_URL: amqp://rabbitmq:5672
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CERT_PATH: /grpc-certs/notes.crt
      GRPC_TLS_KEY_PATH: /grpc-certs/notes.key
      GRPC_TLS_CLIENT_CA_PATH: /grpc-certs/ca.crt
    depends_on:
      mongo-notes:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8004/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  notes-service-2:
    build:
      context: ./notes-service
    environment:
      MONGODB_URL: mongodb://mongo-notes:27017
      MONGODB_DB: tasknotes
      RABBITMQ_URL: amqp://rabbitmq:5672
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CERT_PATH: /grpc-certs/notes.crt
      GRPC_TLS_KEY_PATH: /grpc-certs/notes.key
      GRPC_TLS_CLIENT_CA_PATH: /grpc-certs/ca.crt
    depends_on:
      mongo-notes:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8004/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  tags-service:
    build:
      context: ./tags-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-tags:5432/tasknotes_tags_service
      RABBITMQ_URL: amqp://rabbitmq:5672
    # Internal-only; access via gateway
    depends_on:
      postgres-tags:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8005/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  tags-service-2:
    build:
      context: ./tags-service
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres-tags:5432/tasknotes_tags_service
      RABBITMQ_URL: amqp://rabbitmq:5672
    depends_on:
      postgres-tags:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('http://localhost:8005/healthz').status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  categories-service:
    build:
      context: ./categories-service-dotnet
    environment:
      ASPNETCORE_URLS: http://+:8006
      ASPNETCORE_ENVIRONMENT: Production
      POSTGRES_CONNECTION: Host=postgres-categories;Port=5432;Database=tasknotes_categories_dotnet;Username=postgres;Password=postgres
      RABBITMQ_HOST: rabbitmq
    # Internal-only; access via gateway
    depends_on:
      postgres-categories:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net

  categories-service-2:
    build:
      context: ./categories-service-dotnet
    environment:
      ASPNETCORE_URLS: http://+:8006
      ASPNETCORE_ENVIRONMENT: Production
      POSTGRES_CONNECTION: Host=postgres-categories;Port=5432;Database=tasknotes_categories_dotnet;Username=postgres;Password=postgres
      RABBITMQ_HOST: rabbitmq
    depends_on:
      postgres-categories:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net

  user-profile-service:
    build:
      context: ./user-profile-service
    environment:
      ASPNETCORE_URLS: http://+:8007
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__Default: Host=postgres-user-profile;Port=5432;Database=tasknotes_user_profile_service;Username=postgres;Password=postgres
      RABBITMQ_HOST: rabbitmq
    depends_on:
      postgres-user-profile:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net

  user-profile-service-2:
    build:
      context: ./user-profile-service
    environment:
      ASPNETCORE_URLS: http://+:8007
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__Default: Host=postgres-user-profile;Port=5432;Database=tasknotes_user_profile_service;Username=postgres;Password=postgres
      RABBITMQ_HOST: rabbitmq
    depends_on:
      postgres-user-profile:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net

  logs-service:
    build:
      context: ./logs-service-java
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SPRING_RABBITMQ_VIRTUAL_HOST: /
      SPRING_RABBITMQ_ADDRESSES: rabbitmq:5672
      MONGODB_URL: mongodb://mongo-logs:27017/tasknotes_logs_service
      EXCHANGE_NAME: tasknotes.events
      LOGS_QUEUE: logs-service
      LOGS_BINDINGS: task.*,note.*,category.*,tag.*,user.updated
    depends_on:
      mongo-logs:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net

  nginx-lb:
    build:
      context: ./nginx-lb
    restart: always
    networks:
      - internal-net
    depends_on:
      auth-service:
        condition: service_healthy
      auth-service-2:
        condition: service_healthy
      tasks-service:
        condition: service_healthy
      tasks-service-2:
        condition: service_healthy
      notes-service:
        condition: service_healthy
      notes-service-2:
        condition: service_healthy
      search-service:
        condition: service_healthy
      search-service-2:
        condition: service_healthy
      tags-service:
        condition: service_healthy
      tags-service-2:
        condition: service_healthy
      categories-service:
        condition: service_started
      categories-service-2:
        condition: service_started
      user-profile-service:
        condition: service_started
      user-profile-service-2:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:0.11.0
    command: ["-nginx.scrape-uri=http://nginx-lb:9100/stub_status"]
    restart: always
    depends_on:
      nginx-lb:
        condition: service_started
    networks:
      - internal-net

  # =====================
  # Database Exporters
  # =====================
  postgres-exporter-auth:
    image: prometheuscommunity/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres-auth:5432/tasknotes_auth_service?sslmode=disable"
    restart: always
    depends_on:
      postgres-auth:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=postgres"
      - "database=auth"

  postgres-exporter-tasks:
    image: prometheuscommunity/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres-tasks:5432/tasknotes_tasks_service?sslmode=disable"
    restart: always
    depends_on:
      postgres-tasks:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=postgres"
      - "database=tasks"

  postgres-exporter-tags:
    image: prometheuscommunity/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres-tags:5432/tasknotes_tags_service?sslmode=disable"
    restart: always
    depends_on:
      postgres-tags:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=postgres"
      - "database=tags"

  postgres-exporter-categories:
    image: prometheuscommunity/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres-categories:5432/tasknotes_categories_dotnet?sslmode=disable"
    restart: always
    depends_on:
      postgres-categories:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=postgres"
      - "database=categories"

  postgres-exporter-user-profile:
    image: prometheuscommunity/postgres-exporter:latest
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres-user-profile:5432/tasknotes_user_profile_service?sslmode=disable"
    restart: always
    depends_on:
      postgres-user-profile:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=postgres"
      - "database=user-profile"

  rabbitmq-exporter:
    image: kbudde/rabbitmq-exporter:latest
    environment:
      RABBIT_URL: "http://guest:guest@rabbitmq:15672"
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=rabbitmq"

  mongodb-exporter-notes:
    image: bitnami/mongodb-exporter:latest
    environment:
      MONGODB_URI: "mongodb://mongo-notes:27017/tasknotes"
    restart: always
    depends_on:
      mongo-notes:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=mongodb"
      - "database=notes"

  mongodb-exporter-logs:
    image: bitnami/mongodb-exporter:latest
    environment:
      MONGODB_URI: "mongodb://mongo-logs:27017/tasknotes_logs_service"
    restart: always
    depends_on:
      mongo-logs:
        condition: service_healthy
    networks:
      - internal-net
    labels:
      - "service=mongodb"
      - "database=logs"

  prometheus:
    image: prom/prometheus:latest
    restart: always
    networks:
      - internal-net
      - public-net
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.enable-remote-write-receiver'

  grafana:
    image: grafana/grafana:latest
    restart: always
    networks:
      - internal-net
      - public-net
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus

  influxdb:
    image: influxdb:1.8
    restart: always
    networks:
      - internal-net
      - public-net
    ports:
      - "8086:8086"
    environment:
      INFLUXDB_DB: k6
      INFLUXDB_ADMIN_USER: tasknotes
      INFLUXDB_ADMIN_PASSWORD: changeme
      INFLUXDB_HTTP_AUTH_ENABLED: "true"
    volumes:
      - influxdb-data:/var/lib/influxdb
    labels:
      - "service=influxdb"

  alertmanager:
    image: prom/alertmanager:latest
    restart: always
    networks:
      - internal-net
      - public-net
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'

  api-gateway:
    build:
      context: ./api-gateway
    environment:
      AUTH_SERVICE_URL: http://nginx-lb:9002
      TASKS_SERVICE_URL: http://nginx-lb:9003
      NOTES_SERVICE_URL: http://nginx-lb:9004
      TAGS_SERVICE_URL: http://nginx-lb:9005
      CATEGORIES_SERVICE_URL: http://nginx-lb:9006
      USER_PROFILE_SERVICE_URL: http://nginx-lb:9007
      SEARCH_SERVICE_URL: http://nginx-lb:9008
      JWT_ALGORITHM: HS256
      JWT_SECRET_KEY: change-me-in-prod
      SKIP_JWT_SIGNATURE_VERIFY: "true"
      JWKS_URL: http://auth-service:8002/.well-known/jwks.json
      ENABLE_HTTPS: "true"
      TLS_CERT_PATH: /certs/gateway.crt
      TLS_KEY_PATH: /certs/gateway.key
      # Elevate rate limiting for performance tests
      RATE_LIMIT_WINDOW_SECONDS: 1
      RATE_LIMIT_POST_PER_WINDOW: 1000
    ports:
      - "8083:8083"
      - "8443:8443"
    volumes:
      - ./certs:/certs:ro
    depends_on:
      - auth-service
      - auth-service-2
      - nginx-lb
      - tasks-service
      - tasks-service-2
      - notes-service
      - notes-service-2
      - tags-service
      - tags-service-2
      - categories-service
      - categories-service-2
      - user-profile-service
      - user-profile-service-2
      - search-service
      - search-service-2
      - logs-service
    networks:
      - public-net
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,ssl,sys; ctx=ssl._create_unverified_context();  sys.exit(0) if urllib.request.urlopen('https://localhost:8443/health', context=ctx).status==200 else sys.exit(1)\" "]
      interval: 30s
      timeout: 10s
      retries: 5

  search-service:
    build:
      context: ./search-service
    environment:
      PORT: 8008
      NOTES_GRPC_ADDR: notes-service:50051
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CA_CERT: /grpc-certs/ca.crt
      GRPC_TLS_CLIENT_CERT: /grpc-certs/search-client.crt
      GRPC_TLS_CLIENT_KEY: /grpc-certs/search-client.key
      GRPC_TLS_SERVER_NAME_NOTES: notes-service
      GRPC_TLS_SERVER_NAME_TASKS: tasks-service
      REDIS_URL: redis:6379
      CACHE_TTL_SECONDS: 120
      RABBITMQ_URL: amqp://rabbitmq:5672
    depends_on:
      notes-service:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro

  search-service-2:
    build:
      context: ./search-service
    environment:
      PORT: 8008
      NOTES_GRPC_ADDR: notes-service:50051
      GRPC_TLS_ENABLE: "true"
      GRPC_TLS_CA_CERT: /grpc-certs/ca.crt
      GRPC_TLS_CLIENT_CERT: /grpc-certs/search-client.crt
      GRPC_TLS_CLIENT_KEY: /grpc-certs/search-client.key
      GRPC_TLS_SERVER_NAME_NOTES: notes-service
      GRPC_TLS_SERVER_NAME_TASKS: tasks-service
      REDIS_URL: redis:6379
      CACHE_TTL_SECONDS: 120
      RABBITMQ_URL: amqp://rabbitmq:5672
    depends_on:
      notes-service:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: always
    networks:
      - internal-net
    volumes:
      - ./certs/grpc:/grpc-certs:ro

  # Frontends
  frontend-micro:
    build:
      context: ./frontend-micro
      args:
        REACT_APP_API_URL: https://localhost:8443
        REACT_APP_SEARCH_URL: https://localhost:8443
        REACT_APP_SOCKET_URL: https://localhost:8443
    ports:
      - "8080:80"
    depends_on:
      - api-gateway
    networks:
      - public-net

  frontend-ssr:
    build:
      context: ./frontend-ssr
    environment:
      WEB_URL_PUBLIC: http://localhost:8080
      GATEWAY_URL_PUBLIC: https://localhost:8443
      WEB_URL_INTERNAL: http://frontend-micro:80
      WEB_HEALTH_URL: http://frontend-micro:80/
    ports:
      - "3000:3000"
    depends_on:
      - api-gateway
      - frontend-micro
    networks:
      - public-net

networks:
  public-net:
    driver: bridge
  internal-net:
    driver: bridge
    internal: true

volumes:
  pgdata_auth:
  pgdata_tasks:
  pgdata_tags:
  pgdata_categories:
  pgdata_user_profile:
  mongodata_notes:
  mongodata_logs:
  grafana-storage:
  influxdb-data:
  prometheus-data:

