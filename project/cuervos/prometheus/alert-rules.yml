groups:
  - name: tasknotes.rules
    rules:
      # Target Down Alert
      - alert: TargetDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Target {{ $labels.instance }} is down"
          description: "{{ $labels.job }} target {{ $labels.instance }} has been down for more than 1 minute."

      # High Latency Alert
      - alert: HighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (service, le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on {{ $labels.service }}"
          description: "{{ $labels.service }} has P95 latency above 2 seconds for more than 5 minutes."

      # High Error Rate Alert
      - alert: HighErrorRate
        expr: sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (service) / sum(rate(http_requests_total[5m])) by (service) * 100 > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "{{ $labels.service }} has error rate above 5% for more than 5 minutes."

      # Database Connection Saturation
      - alert: DBConnectionSaturation
        expr: pg_stat_activity_count / pg_settings_max_connections * 100 > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Database connection saturation on {{ $labels.database }}"
          description: "Database {{ $labels.database }} has more than 80% connections in use."

      # RabbitMQ Queue Backlog
      - alert: RabbitMQQueueBacklog
        expr: rabbitmq_queue_messages_ready > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "RabbitMQ queue backlog on {{ $labels.queue }}"
          description: "Queue {{ $labels.queue }} has more than 1000 ready messages for more than 5 minutes."

      # MongoDB High Connections
      - alert: MongoDBHighConnections
        expr: mongodb_mongod_connections > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB high connections on {{ $labels.database }}"
          description: "MongoDB {{ $labels.database }} has more than 100 active connections."

      # Low Cache Hit Ratio
      - alert: LowCacheHitRatio
        expr: pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read) * 100 < 90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit ratio on {{ $labels.database }}"
          description: "Database {{ $labels.database }} has cache hit ratio below 90% for more than 10 minutes."