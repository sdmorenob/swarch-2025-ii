apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: tasknotes
spec:
  serviceName: mongodb
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
        - name: mongodb
          image: mongo:6
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 27017
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-root
                  key: MONGO_INITDB_ROOT_USERNAME
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-root
                  key: MONGO_INITDB_ROOT_PASSWORD
            - name: MONGO_INITDB_DATABASE
              value: tasknotes
          command:
            - /bin/bash
            - -c
            - |
              mongod --replSet rs0 --bind_ip_all &
              MONGOD_PID=$!
              
              # Wait for MongoDB to start
              until mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
                echo "Waiting for MongoDB to start..."
                sleep 2
              done
              
              # Initialize replica set only on mongodb-0
              if [[ "${HOSTNAME}" == "mongodb-0" ]]; then
                echo "Initializing replica set..."
                mongosh --eval "
                  rs.initiate({
                    _id: 'rs0',
                    members: [
                      { _id: 0, host: 'mongodb-0.mongodb.tasknotes.svc.cluster.local:27017' },
                      { _id: 1, host: 'mongodb-1.mongodb.tasknotes.svc.cluster.local:27017' },
                      { _id: 2, host: 'mongodb-2.mongodb.tasknotes.svc.cluster.local:27017' }
                    ]
                  })
                " || echo "Replica set already initialized"
              fi
              
              # Wait for mongod process
              wait $MONGOD_PID
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
            - name: mongodb-init
              mountPath: /docker-entrypoint-initdb.d/init.js
              subPath: init.js
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          readinessProbe:
            tcpSocket:
              port: 27017
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 27017
            initialDelaySeconds: 20
            periodSeconds: 20
      volumes:
        - name: mongodb-init
          configMap:
            name: mongodb-init-script
  volumeClaimTemplates:
    - metadata:
        name: mongodb-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3
        resources:
          requests:
            storage: 20Gi