services:
  # Reverse Proxy (Nginx) para terminación TLS en el borde
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "8080:80"   # Cambiado: El host usa 8080, el contenedor sigue usando 80
      - "443:443"   # Puerto seguro principal
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/tls:/etc/nginx/tls:ro # Monta los certificados
    depends_on:
      - landing-page
      - frontend
      - api-gateway
    networks:
      - public-net

  # API Gateway (Java/Spring Cloud Gateway) - No necesita exponer puertos al host
  api-gateway:
    build:
      context: ./api_gateway_2.1
    container_name: api-gateway
    ports:
      - "8081:8080"  # Exponer puerto para monitoreo de Circuit Breakers
    depends_on:
      - auth-service
      - activities-service
      - gamification-service
      - users-service
      - posts-service
      - admin-service
    networks:
      - public-net  # Nginx se comunica con el gateway por aquí
      - private-net # El gateway se comunica con los servicios por aquí

  # Landing Page Microfrontend (Next.js - puerto 3001)
  landing-page:
    build:
      context: ./landing-page
    container_name: landing-page
    environment:
      - NEXT_PUBLIC_FRONTEND_URL=https://localhost
    networks:
      - public-net  # Conectado a la red pública

  # Frontend Principal (Next.js - puerto 3000)
  frontend:
    build:
      context: ./front
    container_name: frontend
    depends_on:
      - api-gateway
    environment:
      - GEMINI_API_KEY=
      # URLs apuntan al dominio seguro (localhost en dev) que pasa por Nginx
      - NEXT_PUBLIC_AUTH_API_URL=https://localhost/api/auth
      - NEXT_PUBLIC_USER_API_URL=https://localhost/api/users
      - NEXT_PUBLIC_GAMIFICATION_API_URL=https://localhost/api/gamification
      - NEXT_PUBLIC_ACTIVITIES_API_URL=https://localhost/api/activities
      - NEXT_PUBLIC_POSTS_API_URL=https://localhost/api/posts
      - NEXT_PUBLIC_ADMIN_API_URL=https://localhost/api/admin
      - NEXT_PUBLIC_PHYSICAL_ACTIVITIES_API_URL=https://localhost/api/physical-activities
      - NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyBahlztUM-HxBN5chRXm4bg3_tfac327qc
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=retofit-65d7f.firebaseapp.com
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=retofit-65d7f
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=retofit-65d7f.firebasestorage.app
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=84767435359
      - NEXT_PUBLIC_FIREBASE_APP_ID=1:84767435359:web:fd2e56a651adb79d0e89ea
      - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-1P33Y9WDD2
      - GEMINI_API_KEY=AIzaSyCQvZqvJV3vxdGgWwX_rRTahb8bvQHf2p8
    networks:
      - public-net  # Conectado a la red pública
  
  # Auth Service (Python/FastAPI - puerto 8001)
  auth-service:
    build:
      context: ./services/auth-service
    container_name: auth-service
    environment:
      - DATABASE_URL=postgresql://postgres:Retofit2025@retofit.cd66iick6o60.us-east-2.rds.amazonaws.com:5432/retofit_auth
      - MAIL_USERNAME=retofitapp@gmail.com
      - MAIL_PASSWORD=ubid jqul mzmg nnwh
      - MAIL_FROM=retofitapp@gmail.com
      - MAIL_PORT=587
      - MAIL_SERVER=smtp.gmail.com
      - MAIL_USE_TLS=true
      - MAIL_USE_SSL=false
      - SECRET_KEY=f40cf292b97e6ec1e40e6a376e035ee9ebd9369c9dc233c474216ec0fe1b54aa
      - ALGORITHM=HS256
      - BACKEND_URL=http://auth-service:8000
      - PORT=8001 # Hacer explícito el puerto
      - FRONTEND_URL=https://localhost
    networks:
      - private-net # Conectado a la red privada

  # Activities Service (Go - puerto 8002)
  activities-service:
    build:
      context: ./services/physical_activities_service
    container_name: activities-service
    environment:
      - ENV=development
      - SERVER_ADDRESS=activities-service:8002
      - CORS_ALLOWED_ORIGIN=127.0.0.1:3000
      - DB_DRIVER=postgres
      - DB_SOURCE=postgresql://postgres:Retofit2025@retofit.cd66iick6o60.us-east-2.rds.amazonaws.com:5432/retofit_activities
    networks:
      - private-net # Conectado a la red privada

  # Gamification Service (Python/FastAPI - puerto 8003)
  gamification-service:
    build:
      context: ./services/gamification-service
    container_name: gamification-service
    environment:
      - DATABASE_URL=mongodb://mongo:wMssbdHQqDrJaPwUGqtqyfoqmPHvneJZ@gondola.proxy.rlwy.net:10201/retofit_gamification?authSource=admin
      - PORT=8000 # Hacer explícito el puerto
    networks:
      - private-net # Conectado a la red privada

  # Users Service (Python/FastAPI - puerto 8004)
  users-service:
    build:
      context: ./services/user-service
    container_name: users-service
    environment:
      - DATABASE_URL=postgresql://postgres:Retofit2025@retofit.cd66iick6o60.us-east-2.rds.amazonaws.com:5432/retofit_users
      - SECRET_KEY=f40cf292b97e6ec1e40e6a376e035ee9ebd9369c9dc233c474216ec0fe1b54aa
      - ALGORITHM=HS256
      - PORT=8000 # Hacer explícito el puerto
    networks:
      - private-net # Conectado a la red privada

  # Posts Service (Node.js/Prisma - puerto 8005)
  posts-service:
    build:
      context: ./services/posts-service
    container_name: posts-service
    environment:
      - DATABASE_URL=postgresql://postgres:Retofit2025@retofit.cd66iick6o60.us-east-2.rds.amazonaws.com:5432/retofit_posts?sslmode=no-verify
      - SECRET_KEY=f40cf292b97e6ec1e40e6a376e035ee9ebd9369c9dc233c474216ec0fe1b54aa
      - ALGORITHM=HS256
      - PORT=8000
      - NODE_ENV=development
      - API_BASE_URL=http://localhost:8005
      - MAX_FILE_SIZE=5242880
      - UPLOAD_DIR=./uploads
      - CLOUDINARY_CLOUD_NAME=dpsncmfxz
      - CLOUDINARY_API_KEY=848674259162179
      - CLOUDINARY_API_SECRET=6zQbbB8L-cZQbKT1MLIkuKKuqFg
    networks:
      - private-net # Conectado a la red privada

  # Admin Service (PHP - puerto 8006)
  admin-service:
    build:
      context: ./services/admin-service
    container_name: admin-service
    environment:
      - FRONTEND_URL=https://localhost
      - AUTH_SERVICE_URL=http://auth-service:8001
      - USER_SERVICE_URL=http://users-service:8004
      - CHALLENGES_DATABASE_URL=postgresql://postgres:Retofit2025@retofit.cd66iick6o60.us-east-2.rds.amazonaws.com:5432/retofit_retos
    networks:
      - private-net # Conectado a la red privada 
      
# --- Definición de las nuevas redes ---
networks:
  public-net: # Red para la comunicación Frontend <-> Gateway
    driver: bridge
  private-net: # Red aislada para Gateway <-> Microservicios
    driver: bridge
