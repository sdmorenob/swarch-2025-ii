# MusicShare - Load Balancing Configuration Examples
# Este archivo contiene ejemplos de configuración para el balanceo de carga

# ==============================================
# CONFIGURACIÓN DE RÉPLICAS INICIALES
# ==============================================
# Estos valores se definen en docker-compose.yml bajo deploy.replicas
# Modifica según las necesidades de tu infraestructura

# UserService - Servicio de autenticación y usuarios
# Recomendado: 2-5 réplicas según número de usuarios concurrentes
USERSERVICE_REPLICAS=2

# MusicService - Servicio de música y streaming
# Recomendado: 2-8 réplicas (alto consumo de I/O)
MUSICSERVICE_REPLICAS=2

# SocialService - Servicio de interacciones sociales
# Recomendado: 2-5 réplicas según actividad social
SOCIALSERVICE_REPLICAS=2

# NotificationService - Servicio de notificaciones
# Recomendado: 2-4 réplicas (WebSockets requieren sticky sessions)
NOTIFICATIONSERVICE_REPLICAS=2

# ==============================================
# ALGORITMOS DE BALANCEO
# ==============================================
# Traefik soporta varios algoritmos (configurar en labels):
# - wrr: Weighted Round Robin (por defecto)
# - leastconn: Least Connections (envía a la menos ocupada)

LOADBALANCER_ALGORITHM=wrr

# ==============================================
# STICKY SESSIONS
# ==============================================
# Mantener sesiones de usuario en la misma réplica
# true = habilitado (recomendado para servicios con estado)
# false = deshabilitado (mejor distribución de carga)

STICKY_SESSIONS_ENABLED=true
STICKY_COOKIE_NAME_PREFIX=musicshare

# ==============================================
# HEALTH CHECKS
# ==============================================
# Configuración de verificación de salud de réplicas

HEALTHCHECK_INTERVAL=10s
HEALTHCHECK_TIMEOUT=5s
HEALTHCHECK_RETRIES=3

# Rutas de health check por servicio
USERSERVICE_HEALTH_PATH=/health
MUSICSERVICE_HEALTH_PATH=/health
SOCIALSERVICE_HEALTH_PATH=/actuator/health
NOTIFICATIONSERVICE_HEALTH_PATH=/health

# ==============================================
# LÍMITES DE RECURSOS POR RÉPLICA
# ==============================================

# UserService
USERSERVICE_CPU_LIMIT=0.5
USERSERVICE_CPU_RESERVATION=0.25
USERSERVICE_MEMORY_LIMIT=512M
USERSERVICE_MEMORY_RESERVATION=256M

# MusicService (mayor recursos por I/O)
MUSICSERVICE_CPU_LIMIT=0.75
MUSICSERVICE_CPU_RESERVATION=0.5
MUSICSERVICE_MEMORY_LIMIT=768M
MUSICSERVICE_MEMORY_RESERVATION=512M

# SocialService
SOCIALSERVICE_CPU_LIMIT=0.75
SOCIALSERVICE_CPU_RESERVATION=0.5
SOCIALSERVICE_MEMORY_LIMIT=1024M
SOCIALSERVICE_MEMORY_RESERVATION=512M

# NotificationService
NOTIFICATIONSERVICE_CPU_LIMIT=0.5
NOTIFICATIONSERVICE_CPU_RESERVATION=0.25
NOTIFICATIONSERVICE_MEMORY_LIMIT=512M
NOTIFICATIONSERVICE_MEMORY_RESERVATION=256M

# ==============================================
# POLÍTICAS DE REINICIO
# ==============================================

RESTART_CONDITION=on-failure
RESTART_DELAY=5s
RESTART_MAX_ATTEMPTS=3

# ==============================================
# MÉTRICAS Y MONITOREO
# ==============================================

# Habilitar métricas de Prometheus
PROMETHEUS_METRICS_ENABLED=true

# Traefik Dashboard
TRAEFIK_DASHBOARD_ENABLED=true
TRAEFIK_DASHBOARD_PORT=8080

# Nivel de logs
# DEBUG, INFO, WARN, ERROR
LOG_LEVEL=DEBUG

# ==============================================
# NOTAS DE USO
# ==============================================
# 1. Para aplicar cambios en réplicas durante ejecución:
#    docker compose up -d --scale userservice=5 --no-recreate
#
# 2. Para usar el script de escalado:
#    .\scripts\scale-service.ps1 -Service userservice -Replicas 5
#
# 3. Para probar el balanceo:
#    .\scripts\load-test.ps1 -Service userservice -Requests 20
#
# 4. Dashboard de Traefik:
#    http://localhost:8080/dashboard/
