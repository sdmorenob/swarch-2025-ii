# IngressRoutes para los servicios backend
# Estas rutas son gestionadas por Traefik y reemplazan a los labels en Docker Compose

---
# IngressRoute para Frontend
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: frontend-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/`)
      kind: Rule
      services:
        - name: frontend
          port: 80
---
# IngressRoute para User Service
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: userservice-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/api/users`)
      kind: Rule
      middlewares:
        - name: strip-users
      services:
        - name: userservice
          port: 8002
---
# Middleware para strip prefix (definido via CRD)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-users
  namespace: musicshare
spec:
  stripPrefix:
    prefixes:
      - /api/users
---
# IngressRoute para Music Service
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: musicservice-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/api/music`)
      kind: Rule
      middlewares:
        - name: strip-music
      services:
        - name: musicservice
          port: 8081
---
# Middleware para music service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-music
  namespace: musicshare
spec:
  stripPrefix:
    prefixes:
      - /api/music
---
# IngressRoute para Social Service
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: socialservice-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/api/social`)
      kind: Rule
      middlewares:
        - name: strip-social
      services:
        - name: social-service
          port: 8083
---
# Middleware para social service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-social
  namespace: musicshare
spec:
  stripPrefix:
    prefixes:
      - /api/social
---
# IngressRoute para Notification Service
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: notificationservice-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/api/notifications`)
      kind: Rule
      middlewares:
        - name: strip-notifications
      services:
        - name: notificationservice
          port: 8082
    # Ruta separada para WebSockets
    - match: PathPrefix(`/ws`)
      kind: Rule
      services:
        - name: notificationservice
          port: 8082
---
# Middleware para notification service
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-notifications
  namespace: musicshare
spec:
  stripPrefix:
    prefixes:
      - /api/notifications
---
# IngressRoute para Traefik Dashboard
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: dashboard
  namespace: musicshare
spec:
  entryPoints:
    - web
  routes:
    - match: PathPrefix(`/dashboard`)
      kind: Rule
      services:
        - name: api@internal
---
# IngressRoute for API Gateway
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: apigateway-route
  namespace: musicshare
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: PathPrefix(`/graphql`)
      kind: Rule
      services:
        - name: apigateway
          port: 4000
